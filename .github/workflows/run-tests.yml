name: run-tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 0 * * 0"

jobs:
  laravel-10-on-php82:

    name: PHP${{ matrix.php }} TB${{ matrix.testbench}} LW${{ matrix.livewire }} - ${{ matrix.os-title }} ${{ matrix.dependency-prefer-title }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        php: ["8.2"]
        phpunit: ["^10.0.7"]
        testbench: ["^8.0"]
        livewire: ["^2.11.0"]
        dependency-prefer: ["prefer-stable", "prefer-lowest"]
        phpunit-config-file: ["phpunit.xml.dist"]
        include:
          - os: "ubuntu-latest"
            os-title: "ubuntu"
          - os: "macos-latest"
            os-title: "macos"
          - os: "windows-latest"
            os-title: "win"
          - dependency-prefer: "prefer-stable"
            dependency-prefer-title: "stable"
          - dependency-prefer: "prefer-lowest"
            dependency-prefer-title: "lowest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: fileinfo, mbstring
          coverage: none

#      # find out composer's cache directory on the current os - for the "Cache dependencies (composer)" step below
#      - name: Determine composer's cache directory
#        id: composer-cache
#        run: |
#          echo "::set-output name=dir::$(composer config cache-files-dir)"
#
#      - name: Cache dependencies (composer)
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: php-${{ matrix.php }}-testbench-${{ matrix.testbench }}-livewire-${{ matrix.livewire }}-os-${{ matrix.os }}-dependency-prefer-${{ matrix.dependency-prefer }}-composer-${{ hashFiles('composer.json') }}

      - name: Install dependencies (composer)
        run: |
          composer remove "illuminate/support" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" "phpunit/phpunit:${{ matrix.phpunit }}" "livewire/livewire:${{ matrix.livewire }}" --dev --no-interaction --no-update
          composer update --${{ matrix.dependency-prefer }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/phpunit --configuration=${{ matrix.phpunit-config-file }} --no-coverage --stop-on-failure

  laravel-822-to-9-on-php82:

    name: PHP${{ matrix.php }} TB${{ matrix.testbench}} LW${{ matrix.livewire }} - ${{ matrix.os-title }} ${{ matrix.dependency-prefer-title }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        php: ["8.2"]
        phpunit: ["^9.5.10"]
        testbench: ["^7.0", "^6.22"]
        livewire: ["^2.11.0"]
        dependency-prefer: ["prefer-stable", "prefer-lowest"]
        phpunit-config-file: ["phpunit.up-to-9.xml.dist"]
        include:
          - os: "ubuntu-latest"
            os-title: "ubuntu"
          - os: "macos-latest"
            os-title: "macos"
          - os: "windows-latest"
            os-title: "win"
          - dependency-prefer: "prefer-stable"
            dependency-prefer-title: "stable"
          - dependency-prefer: "prefer-lowest"
            dependency-prefer-title: "lowest"
        exclude:
          - testbench: "^6.22"
            dependency-prefer: "prefer-lowest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: fileinfo, mbstring
          coverage: none

#      # find out composer's cache directory on the current os - for the "Cache dependencies (composer)" step below
#      - name: Determine composer's cache directory
#        id: composer-cache
#        run: |
#          echo "::set-output name=dir::$(composer config cache-files-dir)"
#
#      - name: Cache dependencies (composer)
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: php-${{ matrix.php }}-testbench-${{ matrix.testbench }}-livewire-${{ matrix.livewire }}-os-${{ matrix.os }}-dependency-prefer-${{ matrix.dependency-prefer }}-composer-${{ hashFiles('composer.json') }}

      - name: Install dependencies (composer)
        run: |
          composer remove "illuminate/support" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" "phpunit/phpunit:${{ matrix.phpunit }}" "livewire/livewire:${{ matrix.livewire }}" --dev --no-interaction --no-update
          composer update --${{ matrix.dependency-prefer }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/phpunit --configuration=${{ matrix.phpunit-config-file }} --no-coverage --stop-on-failure

  laravel-10-on-php81:

    name: PHP${{ matrix.php }} TB${{ matrix.testbench}} LW${{ matrix.livewire }} - ${{ matrix.os-title }} ${{ matrix.dependency-prefer-title }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        php: ["8.1"]
        phpunit: ["^10.0.7"]
        testbench: ["^8.0"]
        livewire: ["^2.11.0"]
        dependency-prefer: ["prefer-stable", "prefer-lowest"]
        phpunit-config-file: ["phpunit.xml.dist"]
        include:
          - os: "ubuntu-latest"
            os-title: "ubuntu"
          - os: "macos-latest"
            os-title: "macos"
          - os: "windows-latest"
            os-title: "win"
          - dependency-prefer: "prefer-stable"
            dependency-prefer-title: "stable"
          - dependency-prefer: "prefer-lowest"
            dependency-prefer-title: "lowest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: fileinfo, mbstring
          coverage: none

#      # find out composer's cache directory on the current os - for the "Cache dependencies (composer)" step below
#      - name: Determine composer's cache directory
#        id: composer-cache
#        run: |
#          echo "::set-output name=dir::$(composer config cache-files-dir)"
#
#      - name: Cache dependencies (composer)
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: php-${{ matrix.php }}-testbench-${{ matrix.testbench }}-livewire-${{ matrix.livewire }}-os-${{ matrix.os }}-dependency-prefer-${{ matrix.dependency-prefer }}-composer-${{ hashFiles('composer.json') }}

      - name: Install dependencies (composer)
        run: |
          composer remove "illuminate/support" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" "phpunit/phpunit:${{ matrix.phpunit }}" "livewire/livewire:${{ matrix.livewire }}" --dev --no-interaction --no-update
          composer update --${{ matrix.dependency-prefer }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/phpunit --configuration=${{ matrix.phpunit-config-file }} --no-coverage --stop-on-failure

  laravel-822-to-9-on-php81:

    name: PHP${{ matrix.php }} TB${{ matrix.testbench}} LW${{ matrix.livewire }} - ${{ matrix.os-title }} ${{ matrix.dependency-prefer-title }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        php: ["8.1"]
        phpunit: ["^9.5.10"]
        testbench: ["^7.0", "^6.22"]
        livewire: ["^2.11.0"]
        dependency-prefer: ["prefer-stable", "prefer-lowest"]
        phpunit-config-file: ["phpunit.up-to-9.xml.dist"]
        include:
          - os: "ubuntu-latest"
            os-title: "ubuntu"
          - os: "macos-latest"
            os-title: "macos"
          - os: "windows-latest"
            os-title: "win"
          - dependency-prefer: "prefer-stable"
            dependency-prefer-title: "stable"
          - dependency-prefer: "prefer-lowest"
            dependency-prefer-title: "lowest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: fileinfo, mbstring
          coverage: none

#      # find out composer's cache directory on the current os - for the "Cache dependencies (composer)" step below
#      - name: Determine composer's cache directory
#        id: composer-cache
#        run: |
#          echo "::set-output name=dir::$(composer config cache-files-dir)"
#
#      - name: Cache dependencies (composer)
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: php-${{ matrix.php }}-testbench-${{ matrix.testbench }}-livewire-${{ matrix.livewire }}-os-${{ matrix.os }}-dependency-prefer-${{ matrix.dependency-prefer }}-composer-${{ hashFiles('composer.json') }}

      - name: Install dependencies (composer)
        run: |
          composer remove "illuminate/support" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" "phpunit/phpunit:${{ matrix.phpunit }}" "livewire/livewire:${{ matrix.livewire }}" --dev --no-interaction --no-update
          composer update --${{ matrix.dependency-prefer }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/phpunit --configuration=${{ matrix.phpunit-config-file }} --no-coverage --stop-on-failure

  php80:

    name: PHP${{ matrix.php }} TB${{ matrix.testbench}} LW${{ matrix.livewire }} - ${{ matrix.os-title }} ${{ matrix.dependency-prefer-title }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        php: ["8.0"]
        phpunit: ["^8.5 | ^9.0"]
        testbench: ["^7.0", "^6.0"]
        livewire: ["^2.11.0"]
        dependency-prefer: ["prefer-stable", "prefer-lowest"]
        phpunit-config-file: ["phpunit.up-to-9.xml.dist"]
        include:
          - os: "ubuntu-latest"
            os-title: "ubuntu"
          - os: "macos-latest"
            os-title: "macos"
          - os: "windows-latest"
            os-title: "win"
          - dependency-prefer: "prefer-stable"
            dependency-prefer-title: "stable"
          - dependency-prefer: "prefer-lowest"
            dependency-prefer-title: "lowest"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: fileinfo, mbstring
          coverage: none

#      # find out composer's cache directory on the current os - for the "Cache dependencies (composer)" step below
#      - name: Determine composer's cache directory
#        id: composer-cache
#        run: |
#          echo "::set-output name=dir::$(composer config cache-files-dir)"
#
#      - name: Cache dependencies (composer)
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: php-${{ matrix.php }}-testbench-${{ matrix.testbench }}-livewire-${{ matrix.livewire }}-os-${{ matrix.os }}-dependency-prefer-${{ matrix.dependency-prefer }}-composer-${{ hashFiles('composer.json') }}

      - name: Install dependencies (composer)
        run: |
          composer remove "illuminate/support" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" "phpunit/phpunit:${{ matrix.phpunit }}" "livewire/livewire:${{ matrix.livewire }}" --dev --no-interaction --no-update
          composer update --${{ matrix.dependency-prefer }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/phpunit --configuration=${{ matrix.phpunit-config-file }} --no-coverage --stop-on-failure

  php74:

    name: PHP${{ matrix.php }} TB${{ matrix.testbench}} LW${{ matrix.livewire }} - ${{ matrix.os-title }} ${{ matrix.dependency-prefer-title }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        php: ["7.4"]
        phpunit: ["^8.5 | ^9.0"]
        testbench: ["^6.0"]
        livewire: ["^2.0", "^1.0"]
        dependency-prefer: ["prefer-stable", "prefer-lowest"]
        phpunit-config-file: ["phpunit.up-to-9.xml.dist"]
        include:
          - os: "ubuntu-latest"
            os-title: "ubuntu"
          - os: "macos-latest"
            os-title: "macos"
          - os: "windows-latest"
            os-title: "win"
          - dependency-prefer: "prefer-stable"
            dependency-prefer-title: "stable"
          - dependency-prefer: "prefer-lowest"
            dependency-prefer-title: "lowest"
        exclude:
          - os: "windows-latest"
            livewire: "^1.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: fileinfo, mbstring
          coverage: none

#      # find out composer's cache directory on the current os - for the "Cache dependencies (composer)" step below
#      - name: Determine composer's cache directory
#        id: composer-cache
#        run: |
#          echo "::set-output name=dir::$(composer config cache-files-dir)"
#
#      - name: Cache dependencies (composer)
#        uses: actions/cache@v2
#        with:
#          path: ${{ steps.composer-cache.outputs.dir }}
#          key: php-${{ matrix.php }}-testbench-${{ matrix.testbench }}-livewire-${{ matrix.livewire }}-os-${{ matrix.os }}-dependency-prefer-${{ matrix.dependency-prefer }}-composer-${{ hashFiles('composer.json') }}

      - name: Install dependencies (composer)
        run: |
          composer remove "illuminate/support" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" "phpunit/phpunit:${{ matrix.phpunit }}" "livewire/livewire:${{ matrix.livewire }}" --dev --no-interaction --no-update
          composer update --${{ matrix.dependency-prefer }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/phpunit --configuration=${{ matrix.phpunit-config-file }} --no-coverage --stop-on-failure
